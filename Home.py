# -*- coding: utf-8 -*-
"""
Home.py - Streamlit ë©”ì¸ ì—”íŠ¸ë¦¬
- ë¦¬í¬ êµ¬ì¡°ì— ë§ì¶˜ ì•ˆì „í•œ ê²½ë¡œ/ë¡œë”/í´ë°± í¬í•¨
- ëª¨ë¸(.joblib/.pkl) & ë°ì´í„° ìë™ íƒìƒ‰
- ì‹¤íŒ¨ ì‹œ Traceback í™”ë©´ í‘œì¶œ
"""

import os
import pickle
import traceback
from pathlib import Path

import pandas as pd
import streamlit as st

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê¸°ë³¸ ê²½ë¡œ & ë””ë²„ê·¸ íŒ¨ë„
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
BASE_DIR = Path(__file__).resolve().parent

st.set_page_config(page_title="AI ê¸°ë°˜ LoL ì•„ì´í…œ ë¹Œë“œ ì¶”ì²œ", layout="wide")
st.title("AI ê¸°ë°˜ LoL ì•„ì´í…œ ë¹Œë“œ ì¶”ì²œ")

with st.sidebar:
    st.markdown("### ğŸ§­ Debug")
    st.write("CWD:", os.getcwd())
    st.write("BASE_DIR:", str(BASE_DIR))

def file_status(label: str, p: Path):
    st.sidebar.write(f"{label}: {p} ", "âœ…" if (p and p.exists()) else "âŒ")

def try_or_alert(msg, fn, *args, **kwargs):
    try:
        return fn(*args, **kwargs)
    except Exception as e:
        st.error(f"ğŸš¨ {msg}")
        st.exception(e)
        st.code("".join(traceback.format_exc()))
        st.stop()

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# í›„ë³´ ê²½ë¡œ(ë¦¬í¬ êµ¬ì¡° ê¸°ì¤€) - ì¡´ì¬í•˜ëŠ” ì²« íŒŒì¼ì„ ì±„íƒ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
MODEL_CANDIDATES = [
    BASE_DIR / "lgbm_model_tuned.joblib",           # ë¦¬í¬ ì‹¤ì œ íŒŒì¼
    BASE_DIR / "models" / "scenario1_model.pkl",    # ê³¼ê±° í˜•ì‹(ìˆìœ¼ë©´ ì‚¬ìš©)
]
DATA_CANDIDATES = [
    BASE_DIR / "renamed_data_sample.csv",           # ë¦¬í¬ ì‹¤ì œ íŒŒì¼
    BASE_DIR / "renamed_data.csv",                  # ê³¼ê±° í˜•ì‹(ìˆìœ¼ë©´ ì‚¬ìš©)
]

def first_exist(paths):
    for p in paths:
        file_status("CHECK", p)
        if p.exists():
            return p
    return None

MODEL_PATH = first_exist(MODEL_CANDIDATES)
DATA_PATH  = first_exist(DATA_CANDIDATES)

st.sidebar.write("MODEL_PATH:", MODEL_PATH if MODEL_PATH else "None")
st.sidebar.write("DATA_PATH:",  DATA_PATH if DATA_PATH else "None")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ìºì‹œ ë¡œë”
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
@st.cache_data(show_spinner=False)
def load_df(path: Path) -> pd.DataFrame:
    return pd.read_csv(path)

@st.cache_resource(show_spinner=False)
def load_model_pickle_or_joblib(path: Path):
    # í™•ì¥ìì— ë”°ë¼ ë¡œë”©
    p = str(path).lower()
    if p.endswith(".pkl"):
        with open(path, "rb") as f:
            return pickle.load(f)
    else:
        import joblib
        return joblib.load(path)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ë°ì´í„° ë¡œë“œ
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if DATA_PATH is None:
    st.error("ë°ì´í„° íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. (renamed_data_sample.csv ë˜ëŠ” renamed_data.csv)")
    st.stop()

df = try_or_alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨", load_df, DATA_PATH)

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ëª¨ë¸ ë¡œë“œ (ì—†ìœ¼ë©´ í´ë°±: ì¦‰ì‹œ í•™ìŠµ)
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
if MODEL_PATH is None:
    from ml import train_models  # ë¦¬í¬ì˜ ml.py
    st.warning("ëª¨ë¸ íŒŒì¼ì„ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ì„ì‹œ í•™ìŠµì„ ìˆ˜í–‰í•©ë‹ˆë‹¤. (ì²« ì‹¤í–‰ë§Œ ì§€ì—°ë  ìˆ˜ ìˆìŒ)")
    models = try_or_alert("ì„ì‹œ í•™ìŠµ ì‹¤íŒ¨", train_models, df)
    # train_models ë°˜í™˜ì„ ê·¸ëŒ€ë¡œ ë³´ê´€ (tuple/dict ë¬´ì—‡ì´ë“ )
    st.session_state["models"] = models
    st.success("âœ… ì„ì‹œ í•™ìŠµ ì™„ë£Œ: ì„¸ì…˜ì— ëª¨ë¸ ê°ì²´ë¥¼ ë³´ê´€í–ˆìŠµë‹ˆë‹¤.")
else:
    model_or_bundle = try_or_alert("ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨", load_model_pickle_or_joblib, MODEL_PATH)
    st.session_state["models"] = model_or_bundle
    st.success(f"âœ… ëª¨ë¸ ë¡œë“œ ì™„ë£Œ: {MODEL_PATH.name}")

# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
# ê°„ë‹¨ ìƒíƒœ í‘œì‹œ & ë„¤ë¹„ê²Œì´ì…˜ ì•ˆë‚´
# â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
c1, c2, c3 = st.columns(3)
with c1:
    st.metric("ë°ì´í„° ë¡œìš° ìˆ˜", f"{len(df):,}")
with c2:
    st.metric("ë°ì´í„° ê²½ë¡œ", DATA_PATH.name)
with c3:
    st.metric("ëª¨ë¸ ìƒíƒœ", "ì„¸ì…˜ ë¡œë“œë¨")

st.info("ì™¼ìª½ ì‚¬ì´ë“œë°”ì˜ **Pages** ë©”ë‰´ì—ì„œ â‘  ì‹œë‚˜ë¦¬ì˜¤1 / â‘¡ ì‹œë‚˜ë¦¬ì˜¤2 í˜ì´ì§€ë¥¼ ì„ íƒí•´ ì§„í–‰í•˜ì„¸ìš”.")

# ì„ íƒ: ì´ˆê¸° ì§„ë‹¨ìš© ë¡œê·¸(í•„ìš” ì‹œ ì£¼ì„ í•´ì œ)
# st.write("session_state keys:", list(st.session_state.keys()))
# st.write(st.session_state.get("models"))
